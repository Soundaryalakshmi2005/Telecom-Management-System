document.addEventListener("DOMContentLoaded", function () {
  // Tabs
  const productsTab = document.getElementById("productsTab");
  const suppliersTab = document.getElementById("suppliersTab");
  const transactionsTab = document.getElementById("transactionsTab");

  const productsSection = document.getElementById("productsSection");
  const suppliersSection = document.getElementById("suppliersSection");
  const transactionsSection = document.getElementById("transactionsSection");

  function showSection(sectionToShow) {
    [productsSection, suppliersSection, transactionsSection].forEach(section => {
      section.classList.add("hidden");
    });
    sectionToShow.classList.remove("hidden");
  }

  // Default load products
  showSection(productsSection);
  loadProducts();

  productsTab.addEventListener("click", () => {
    showSection(productsSection);
    loadProducts();
  });
  suppliersTab.addEventListener("click", () => {
    showSection(suppliersSection);
    loadSuppliers();
  });
  transactionsTab.addEventListener("click", () => {
    showSection(transactionsSection);
    loadTransactions();
  });

  // ========== LOAD FUNCTIONS ==========

  function loadProducts() {
    fetch("http://localhost:8080/api/products")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#productsTable tbody");
        tbody.innerHTML = "";
        data.forEach(p => {
          const row = `<tr>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.price}</td>
            <td>${p.stock}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      })
      .catch(err => console.error("Error loading products:", err));
  }

  function loadSuppliers() {
    fetch("http://localhost:8080/api/suppliers")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#suppliersTable tbody");
        tbody.innerHTML = "";
        data.forEach(s => {
          const row = `<tr>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.contactNumber}</td>
            <td>${s.email}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      })
      .catch(err => console.error("Error loading suppliers:", err));
  }

  function loadTransactions() {
    fetch("http://localhost:8080/api/transactions")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#transactionsTable tbody");
        tbody.innerHTML = "";
        data.forEach(t => {
          const row = `<tr>
            <td>${t.id}</td>
            <td>${t.product ? t.product.name : "N/A"}</td>
            <td>${t.quantity}</td>
            <td>${t.type}</td>
            <td>${t.timestamp}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      })
      .catch(err => console.error("Error loading transactions:", err));
  }

  // ========== FORM HANDLERS ==========

  // Add Product
  document.getElementById("productForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const newProduct = {
      name: document.getElementById("prodName").value,
      category: document.getElementById("prodCategory").value,
      price: parseFloat(document.getElementById("prodPrice").value),
      stock: parseInt(document.getElementById("prodStock").value)
    };

    fetch("http://localhost:8080/api/products", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newProduct)
    })
      .then(response => {
        if (!response.ok) {
          return response.text().then(msg => { throw new Error(msg); });
        }
        return response.json();
      })
      .then(() => {
        loadProducts();
        e.target.reset();
      })
      .catch(err => {
        console.error("Error adding product:", err);
        alert("❌ Failed: " + err.message);
      });
  });

  // Add Supplier
  document.getElementById("supplierForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const newSupplier = {
      name: document.getElementById("supName").value,
      contactNumber: document.getElementById("supContact").value,
      email: document.getElementById("supEmail").value
    };

    fetch("http://localhost:8080/api/suppliers", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newSupplier)
    })
      .then(response => {
        if (!response.ok) {
          return response.text().then(msg => { throw new Error(msg); });
        }
        return response.json();
      })
      .then(() => {
        loadSuppliers();
        e.target.reset();
      })
      .catch(err => {
        console.error("Error adding supplier:", err);
        alert("❌ Failed: " + err.message);
      });
  });

  // Add Transaction
  document.getElementById("transactionForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const newTransaction = {
      product: { id: parseInt(document.getElementById("txnProductId").value) },
      quantity: parseInt(document.getElementById("txnQuantity").value),
      type: document.getElementById("txnType").value
    };

    fetch("http://localhost:8080/api/transactions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newTransaction)
    })
      .then(response => {
        if (!response.ok) {
          return response.text().then(msg => { throw new Error(msg); });
        }
        return response.json();
      })
      .then(() => {
        loadTransactions();
        e.target.reset();
      })
      .catch(err => {
        console.error("Error adding transaction:", err);
        alert("❌ Failed: " + err.message);
      });
  });
});
